'use strict';

$(document).ready(function(){
    
    //WHEN "VIEW ALL" IS CLICKED UNDER EXAMS TAKEN
    $("#viewExamHistory").click(function(e){
        e.preventDefault();
        
        $("#mainPageDiv").addClass("hidden");//hide the main div showing on the page
        
        loadHistoryTable();
    });
    
    
    /*
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    */
    
    
    
    
    
    
    /*
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    */
    
    //WHEN "CLOSED" IS CLICKED IN ORDER TO SHOW THE MAIN DIV
    $(".mainPage").on('click', '.showMainDiv', function(){
        $(".mainPage").not("#mainPageDiv").addClass('hidden');
        
        $("#mainPageDiv").removeClass("hidden");
    });
    
    
    
    /*
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    */
    
    //WHEN "EDIT" IS CLICKED IN ORDER TO EDIT THE DETAILS OF A USER
    $("#dashEditUserDet").click(function(){
        $(".dispUserDetForm").addClass("hidden");
        
        $(".editUserDetForm").removeClass("hidden");        
        
        //Hide "Edit" icon and display the text to "cancel" editting
        $(this).addClass("hidden");
        $("#dashStopEditUserDet").removeClass("hidden");
    });
    
    
    /*
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    */
    
    
    //WHEN "CLOSE" IS CLICKED IN ORDER TO STOP EDITTING THE DETAILS OF A USER
    $("#dashStopEditUserDet").click(function(){
        $(".dispUserDetForm").removeClass("hidden");
        
        $(".editUserDetForm").addClass("hidden");
        
        $("#saveEditedDet").html("Save");//change the text on the button to "save" in case it was changed
        
        //Hide "Cancel" and display the "edit"
        $(this).addClass("hidden");
        $("#dashEditUserDet").removeClass("hidden");
    });
    
    
    /*
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    */
    
    
    //WHEN "CLOSE" IS CLICKED WHILE VIEWING EXAM SCRIPT
    $(".mainPage").on('click', ".showExamHistoryDiv", function(){
        $(".mainPage").not("#examsTakenTable").addClass('hidden');
        
        $("#examsTakenTable, #historySortAndCo").removeClass("hidden");
    });
    
    
    /*
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    */
   
   //WHEN THE PAGINATION IS CLICKED ON THE EXAMS TAKEN HISTORY TABLE
   $(".mainPage").on("click", ".histNxtSet", function(e){
       e.preventDefault();
       
       loadHistoryTable($(this).attr('href'));
   });
   
   /*
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    */
   
   //WHEN "SORT BY" AND "SHOW" SELECT ON THE EXAMS TAKEN TABLE ARE CHANGED
   $("#examHistoryShow, #examHistorySort").change(function(){
       loadHistoryTable();
   });
   
   /*
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    */
   
    //WHEN "SAVE" IS CLICKED WHILE EDITING PROFILE
    $("#saveEditedDet").click(function(e){
        e.preventDefault();

        //ONLY ACT IF FORM WAS CHANGED
        //formChanges(formName)
        var formChanged = checkUserEditFormChange();
       
        if(formChanged){
            var username = $("#dashUsername").val();
            var firstName = $("#dashFirstName").val();
            var lastName = $("#dashLastName").val();
            var gender = $("#dashGender").val();

            if(!firstName || !lastName){
                !firstName ? $("#dashFirstName").css({'borderColor':'red'}) : $("#dashFirstName").css({'borderColor':''});
                !lastName ? $("#dashLastName").css({'borderColor':'red'}) : $("#dashLastName").css({'borderColor':''});

                return;
            }

            //show loading
            $("#saveEditedDet").html("<i class='"+spinnerClass + "'></i> Saving...");

            //make ajax req
            $.ajax({
                url: appRoot+"dashboard/up_us_det",
                data: {username:username, first_name:firstName, last_name:lastName, gender:gender},
                method: "POST"
            }).done(function(returnedData){
                if(returnedData.status === 1){
                    $("#saveEditedDet").html("Changes Saved");
                    
                    //update the details of spans displaying the details with the values of the form fields
                    $(".dispUserDetForm").each(function(){
                        $(this).html($(this).siblings(".editUserDetForm").val());
                    });
                    
                    //change the text on the button back to "save"
                    setTimeout(function(){
                        $("#saveEditedDet").html("Save");
                        
                        //then close the edit inteface
                        $("#dashStopEditUserDet").click();
                    }, 1000);
                    
                    //UPDATE LAST EDITED
                    $("#detLastEdit").html("Just now");
                }
                
                else{
                    $("#saveEditedDet").html("<i class='fa fa-exclamation'></i> Update Failed");
                }
            });
        }
    });
   
   /*
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    */
   
    //WHEN "VIEW" IS CLICKED IN ORDER TO VIEW THE SCRIPT OF A TAKEN EXAM
    $(".mainPage").on('click', '.viewExamHistoryScript', function(e){
        e.preventDefault();
       
        var rId = $(this).attr('id').split("-")[1];
        
        //get the element of the score and time spent
        //as they will be used to set the time spent and score on the div we are loading
        var scoreElem = $(this).parents('td').siblings(".histPercentage");
        var timeElem = $(this).parents('td').siblings(".histTimeSpentInSec");
       
        //hide all mainPage divs except the one we want to display the script in
        $(".mainPage").not("#examHistoryScript").addClass("hidden");
           
        //unhide the div we want to display
        $("#examHistoryScript").removeClass("hidden");
        
        //show the loading icon
        $("#examHistoryScript").html(loaderDiv + " Loading... This might take a while");
       
        //load the script
        $("#examHistoryScript").load(appRoot+"questions/exam_script", {rId:rId}, function(){
            
            $("#yourScore").append(scoreElem.html()+"%");
            $("#timeYouSpent").append(timeElem.html());
        });
    });
   
   /*
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    */
   
   
   //WHEN "VIEW ALL" IS CLICKED UNDER QUIZ
   $("#viewCreatedQuizzes").click(function(){
        //alert("Created Quizzes");
        //make server req to get the list of all quiz created by currently logged in user
        $("#mainPageDiv").addClass("hidden");//hide the main div showing on the page
        
        
        getUsersCreatedQuizzes();
   });
   
   
   /*
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    */
   
   
    //WHEN "SORT BY" AND "SHOW" SELECT ON THE CREATED QUIZ TABLE ARE CHANGED
    $("#createdQuizShow, #createdQuizSort").change(function(){
        getUsersCreatedQuizzes();
    });
   
   
   /*
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    */
   
   //WHEN THE PAGINATION IS CLICKED ON QUIZ CREATED TABLE
   $(".mainPage").on("click", ".createdQuizNxtSet", function(e){
       e.preventDefault();
       
       getUsersCreatedQuizzes($(this).attr('href'));
   });
   
   
   /*
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    */
   
   //WHEN A QUIZ TITLE IS CLICKED IN ORDER TO VIEW THE QUESTIONS ON IT
   $(".mainPage").on('click', '.viewCreatedQuizQuestions', function(e){
       e.preventDefault();
       var qId = $(this).parents('td').siblings('input[type=hidden]').val();
       
       if(qId){           
           //show 'loading'
           $("#createdQuizQuestions").html(loaderDiv + "Fetching Questions...").removeClass("hidden");
           
           $("#createdQuizQuestions").load(appRoot+"quiz/getquiz", {qId:qId}, function(){
               //hide the div showing info about the quiz
               $("#pubQuizInfoDiv").addClass("hidden");
               
               //scroll to the div
               scrollToDiv("#createdQuizQuestions");
           });
       }
   });
   
   /*
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    */
   
   //TO VIEW THE TABLE OF PEOPLE THAT HAVE TAKEN A PARTICULAR QUIZ CREATED BY USER
   $(".mainPage").on('click', '.viewCreatedQuizResults', function(e){
       e.preventDefault();
       
       var qId = $(this).parents('td').siblings('input[type=hidden]').val();
       
       if(qId){           
           
           //hide all div with 'mainPage' class except the one the table will be loaded in
           $(".mainPage").not("#createdQuizTakersTable").addClass("hidden");
           
           //make server req
           getQuizResultTable(qId, "");
       }
   });
   
   
   
   /*
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    */
   
   
   //TO SHOW CREATED QUIZ TABLE ONLY
   $(".mainPage").on('click', '.showcreatedQuizTableDiv', function(){
       //hide all div with class ".mainPage" except the ones with ids "createdQuizTable" and "createdQuizSortAndCo"
       $(".mainPage").not($("#createdQuizTable")).addClass("hidden");
       
       $("#createdQuizTable, #createdQuizSortAndCo").removeClass("hidden");//show the div holding the list of created quizzes
   });
   
   
   /*
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    */
   
   //WHEN THE SORT ORDER OR NUMBER OF ROWS TO DISPLAY PER PAGE IS CHANGED
   $(".mainPage").on('change', '#createdQuizTakersTableSort, #createdQuizTakersTableShow', function(){
       var qId = $("#cvqri").val();//cvqri = "Currently Viewed Quiz Result Id"
       
       getQuizResultTable(qId, "");
   });
   
   
   
   /*
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    */
   
   //WHEN THE PAGINATION LINKS ON THE QUIZ TAKER TABLE ARE CLICKED
   $(".mainPage").on('click', '.gqttNxt', function(e){
       e.preventDefault();
       
       var qId = $("#cvqri").val();//cvqri = "Currently Viewed Quiz Result Id"
       var url = $(this).attr('href');
       
       getQuizResultTable(qId, url);
   });
   
   
   
   /*
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    */
   
   //TO VIEW THE SCRIPT OF A PARTICULAR QUIZ RESULT
    $(".mainPage").on('click', '.viewTakenQuizScript', function(e){
        e.preventDefault();
       
        var resultId = $(this).parents("tr").children("input[type=hidden]").val();
       
        if(resultId){
            //hide all mainPage divs except the one we want to display the script in
            $(".mainPage").not("#createdQuizTakersScript").addClass("hidden");

            //unhide the div we want to display (just in case)
            $("#createdQuizTakersScript").removeClass("hidden");

            //show the loading icon
            $("#createdQuizTakersScript").html(loaderDiv + " Loading... This might take a while");
            
            //get the element of the score and time spent
            //as they will be used to set the time spent and score on the div we are loading
            var quizTakerScoreElem = $(this).parents('td').siblings(".qTakerPercentage");
            var quizTakerTimeElem = $(this).parents('td').siblings(".qTakerTimeSpent");

            $("#createdQuizTakersScript").load(appRoot+"quiz/qs", {r:resultId}, function(){
                $("#quizTakerScore").append(quizTakerScoreElem.html()+"%");
                $("#timeQuizTakerSpent").append(quizTakerTimeElem.html());
            });
        }
    });
    
    /*
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    */
    
    //TO SHOW THE QUIZ TAKER TABLE WHEN "CLOSE" IS CLICKED ON THE QUIZ SCRIPT
    $(".mainPage").on('click', '.showQuizResultTableDiv', function(){
        $(".mainPage").not("#createdQuizTakersTable").addClass("hidden");
        
        //then remove the hidden class added to the div showing the quiz taker table and the "sort and co." div for the table
        $("#createdQuizTakersTable, #createdQuizTakersTableSortAndCo").removeClass("hidden");
    });
   
   
   /*
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    */
   
   
   
   
   
   /*
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    */
});




/**
 * 
 * @param {type} url
 * @returns {undefined}
 */
function loadHistoryTable(url){
    var urlToLoad = url ? url : appRoot+"questions/exams_taken";
    
    //show the div where the table will be displayed
    $("#examsTakenTable").html(loaderDiv + "Loading").removeClass("hidden");

    var orderBy = $("#examHistorySort").val() ? $("#examHistorySort").val().split("-")[0] : "";
    var orderFormat = $("#examHistorySort").val() ? $("#examHistorySort").val().split("-")[1] : "";
    var limit = $("#examHistoryShow").val() ? $("#examHistoryShow").val() : "";

    var dataToSend = {order_by:orderBy, order_format:orderFormat, limit:limit};

    //load the table from server
    $("#examsTakenTable").load(urlToLoad, dataToSend, function(){
        //show the history div only if there is at lest one test found
        //#rangeShowing will have a 'value' if at least one test is found in user's history
        var historyFound = $("#rangeShowing").html() ? true : false;
        
        if(historyFound){
            $("#historySortAndCo").removeClass("hidden");//show the sort and co div
            $("#examHistoryRange").html($("#rangeShowing").html());//show the range being displayed
        }        
    });
}



/*
********************************************************************************************************************************
********************************************************************************************************************************
********************************************************************************************************************************
********************************************************************************************************************************
********************************************************************************************************************************
*/
   

/**
 * 
 * @returns {Boolean}
 */
function checkUserEditFormChange(){
    var formChanged = false;
    
    //LOOP THROUGH THE VALUES IN FORM AND THE PLAIN TEXTS DISPLAYED TO SEE IF THEY ARE DIFFERENT
    $(".dispUserDetForm").each(function(){
        if(($(this).html()) !== ($(this).siblings(".editUserDetForm").val())){
            formChanged = true;
        }
    });
    
    return formChanged;
}



/*
********************************************************************************************************************************
********************************************************************************************************************************
********************************************************************************************************************************
********************************************************************************************************************************
********************************************************************************************************************************
*/


/**
 * Get the list of quizzes created by currently logged in user
 * @param {type} url
 * @returns {undefined}
 */
function getUsersCreatedQuizzes(url){
    var urlToLoad = url || appRoot+"quiz/gucqi";
    
    //show the div where the table will be displayed
    $("#createdQuizTable").html(loaderDiv + "Loading").removeClass("hidden");
    
    var orderBy = $("#createdQuizSort").val().split("-")[0] || "";
    var orderFormat = $("#createdQuizSort").val().split("-")[1] || "";
    var limit = $("#createdQuizShow").val() || "";

    var dataToSend = {order_by:orderBy, order_format:orderFormat, limit:limit};

    //load the table from server
    $("#createdQuizTable").load(urlToLoad, dataToSend, function(){
        //show the quiz div only if there is at lest one quiz found
        //#rangeShowing will have a 'value' if at least one test is found in user's history
        var createdQuizFound = $("#createdQuizRangeShowing").html() ? true : false;
        
        if(createdQuizFound){
            $("#createdQuizSortAndCo").removeClass("hidden");//show the sort and co div
            $("#createdQuizRange").html($("#createdQuizRangeShowing").html());//show the range being displayed
        }        
    });
}


/*
********************************************************************************************************************************
********************************************************************************************************************************
********************************************************************************************************************************
********************************************************************************************************************************
********************************************************************************************************************************
*/

function getQuizResultTable(qId, url){
    var urlToLoad = url || appRoot+"quiz/gqtt";
    
    //show 'loading'
    $("#createdQuizTakersTable").html(loaderDiv + "Fetching Results. Please wait...").removeClass("hidden");
    
    var orderBy = $("#createdQuizTakersTableSort").val().split("-")[0] || "";
    var orderFormat = $("#createdQuizTakersTableSort").val().split("-")[1] || "";
    var limit = $("#createdQuizTakersTableShow").val() || "";

    var dataToSend = {q:qId, order_by:orderBy, order_format:orderFormat, limit:limit};

    //load the table from server
    $("#createdQuizTakersTable").load(urlToLoad, dataToSend, function(){
        //show the quiz div only if there is at lest one quiz found
        //#rangeShowing will have a 'value' if at least one test is found in user's history
        var createdQuizFound = $("#createdQuizTakersTableRangeShowing").html() ? true : false;
        
        if(createdQuizFound){
            $("#createdQuizTakersTableSortAndCo").removeClass("hidden");//show the sort and co div
            $("#createdQuizTakersTableRange").html($("#createdQuizTakersTableRangeShowing").html());//show the range being displayed
        }        
    });
}


/*
********************************************************************************************************************************
********************************************************************************************************************************
********************************************************************************************************************************
********************************************************************************************************************************
********************************************************************************************************************************
*/





/*
********************************************************************************************************************************
********************************************************************************************************************************
********************************************************************************************************************************
********************************************************************************************************************************
********************************************************************************************************************************
*/




/*
********************************************************************************************************************************
********************************************************************************************************************************
********************************************************************************************************************************
********************************************************************************************************************************
********************************************************************************************************************************
*/





/*
********************************************************************************************************************************
********************************************************************************************************************************
********************************************************************************************************************************
********************************************************************************************************************************
********************************************************************************************************************************
*/





/*
********************************************************************************************************************************
********************************************************************************************************************************
********************************************************************************************************************************
********************************************************************************************************************************
********************************************************************************************************************************
*/





/*
********************************************************************************************************************************
********************************************************************************************************************************
********************************************************************************************************************************
********************************************************************************************************************************
********************************************************************************************************************************
*/
'use_strict';

$(document).ready(function () {
    //checkDocumentVisibility(checkLogin);//check document visibility in order to confirm user's log in status
    
    //get each exam body on the exam page, then loop through var "publishedQueInfo" and get the courses available for each body
    $(".selectedBody").each(function(){
        var body = $(this).val();
        var bodyCoursesElem = $(this).siblings(".courseSelect").find(".selectedCourse");
        
        //loop through the array of published que info
        //get the body equal to the current body in the loop and loop through it to display the available courses under that body
        $.each(publishedQueInfo, function(publishedBody, publishedBodyCourses){
            if(publishedBody === body){
                $.each(publishedBodyCourses, function(course){
                    //get and set courses available for current exam body in loop
                    bodyCoursesElem.append("<option value='"+course+"'>"+course+"</option>");
                });
            }
        });
    });
    
    
    /*
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    */
   
   
   //When exam course/subject is selected or changed
    $(".selectedCourse").change(function(){
        //remove the red border on elem (in case there is any) when elem is changed and has a value
        $(this).val() ? $(this).css("borderColor", "") : "";
        
        var selectedBody = $(this).parents(".courseSelect").siblings(".selectedBody").val();
        var selectedCourse = $(this).val();
        var yearsElem = $(this).parents(".courseSelect").siblings(".yearSelect").find(".selectedYear");
        
        //loop through the array of published que info
        //get the selected body and loop through it to get all the available courses under the body
        //then loop though the courses to get all the available years in the selected course
        $.each(publishedQueInfo, function(body, bodyCourses){
            if(body === selectedBody){
                //loop through the courses in selectedBody
                $.each(bodyCourses, function(course, year){
                    if(course === selectedCourse){
                        //reset the years displayed
                        yearsElem.html("<option value=''>Year</option>");
                        
                        //get the years available for course and append to year select dropdown options
                        $.each(year, function(){
                            yearsElem.append("<option value='"+this+"'>"+this+"</option>");
                        });
                    }
                });
            }
        });
    });
    
    
    /*
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    */
    
    //set/remove the red border on elem when elem is changed
    $(".selectedYear").change(function(){
        $(this).val() ? $(this).css("borderColor", "") : $(this).css("borderColor", "red");
    });
    
    
    /*
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    */
   
    //When user clicks on "Start" from the Instruction page to start an exam after having selected the exam choice
    $(".startExam").click(function(){
        var courseElem = $(this).parents(".startButton").siblings(".courseSelect").find(".selectedCourse");
        var yrElem = $(this).parents(".startButton").siblings(".yearSelect").find(".selectedYear");
        
        //get the exam body, course and year
        var body = $(this).parents(".startButton").siblings(".selectedBody").val();
        var course = courseElem.val();
        var yr = yrElem.val();
        
        if(!body || !yr || !course){
            //display error
            !course ? courseElem.focus().css("borderColor", "red") : courseElem.focusout().css("borderColor", "");
            !yr ? yrElem.focus().css("borderColor", "red") : yrElem.focusout().css("borderColor", "");
            return;
        }
        
        
        //ensure user is logged in. If yes, continue. If no, prompt user to either log in or register to continue
        checkLogin(function(status){
            
            if(status === 0){//i.e. user's session has expired
                hideFlashMsg();
                
                //change menu to that of guest
                changePageToGuestView();
				
                //launch log in modal prompting the user to log in                
                triggerLoginForm("Log in required. Pls log in or register to take a test", {'color':'red'});
            }
            
            else{
                displayFlashMsg("Please wait...", spinnerClass, '', '');
        
                //call function to handle the fetching of instructions from the server
                getExamInfoFromServer(body, course, yr);
            }
        });
        
    });
    
    
    /*
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    ********************************************************************************************************************************
    */
   
   
   
});'use strict';

//var monitoringFBLoginResponseTime;
var monitorRespTimeForAPICall;

$(document).ready(function(){
    window.fbAsyncInit = function () {
        FB.init({
            appId: '158277964559623',
            xfbml: false,
            version: 'v2.5'
        });
    };

    (function (d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) {
            return;
        }
        js = d.createElement(s);
        js.id = id;
        js.src = "//connect.facebook.net/en_US/sdk.js";
        fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));
            
            
    
    //when the log in button is clicked (STEP ONE)
    $("#fbLogin").click(function (e) {
        e.preventDefault();
        
        $("#signLogModal").modal('hide');
        
        displayFlashMsg("Connecting to Facebook...", spinnerClass, '', '', false);
        
        callFBLogin();//trigger FB login dialog
    });
    
    
    
    //When user clicks the button to share their score on FB (just after finishing an exam)
    $("#pageContent").on('click', '.shareResultOnFB', function(){
        var redirectURI = location.href;
        var pictureLink = appRoot+"public/images/fb_exams.png";
        var userScore = $("#myTestScore").html();
        var examBody = $("#testEBody").val();
        var subject = $("#testECourse").val();
        var year = $("#testEYear").val();

        var textToDisplay = "I just practised all "+examBody+"'s "+ year +" "+ subject +" questions for free on\
         "+appRoot+" and I got "+userScore +". Think you can do better?\
         Click "+location.href+" to take the same test.";

        postToFB(redirectURI, pictureLink, textToDisplay, '');
    });
   
   
   
    //TO SHARE EXAM RESULT ON FB FROM THE DASHBOARD (WHILE VIEWING EXAM SCRIPT)
    $("#pageContent").on('click', '#shareExamResultOnFB', function(){
       var redirectURI = location.href;
        var pictureLink = appRoot+"public/images/fb_exams.png";
        var userScore = $("#yourScore").html().replace("Your Score:", "");
        var examBody = $("#eb").html();
        var subject = $("#ec").html();
        var year = $("#ey").html();

        var textToDisplay = "I just practised all "+examBody+"'s "+ year +" "+ subject +" questions for free on\
         "+appRoot+" and I got "+userScore +". Think you can do better?\
         Click "+location.href+" to take the same test.";

        postToFB(redirectURI, pictureLink, textToDisplay, '');
    });
   
   
    //TO SHARE THE LINK OF A QUIZ CREATED BY A USER ON FB
    $("#pageContent").on('click', '#shareCreatedQuizOnFB', function(){
        var redirectURI = location.href;
        var pictureLink = appRoot+"public/images/fb_gen.jpg";
        var quizId = $(this).siblings("input[type=hidden]").val();
        var textToDisplay = $("#shareQuizMsg").val();
        
        //display error if message is empty
        if(!textToDisplay){
            $("#shareQuizMsg").css({borderColor:'red'}).focus();
            return;
        }
        
        //append link to message if it doesn't contain the link
        if(textToDisplay.search(appRoot+"quiz/tq/"+quizId) === -1){
            textToDisplay = textToDisplay + "\n\n"+appRoot+"quiz/tq/"+quizId;
        }

        postToFB(redirectURI, pictureLink, textToDisplay, function(responseFromFB){
            //responseFromFB.post_id ? $("#shareProgMsg").html(responseFromFB).fadeOut(6000) : "";
            
            setTimeOut(function(){$("#shareQuizModal").modal('hide');}, 2000);
        });
    });
});




/**
 * Try to log user into FB if user was not previously logged into FB or our app (STEP TWO 1/2)
 * @returns {undefined}
 */
function callFBLogin() {
    console.log("Launching login dialog");
    
    //await response from FB for 30secs and show error if nothing was received
    /*
    monitoringFBLoginResponseTime = setTimeout(function(){
        //FB.logout();
        
        //display error message and stop execution
        $("#logInFMsg").css({'color':'red', 'fontSize':'11px'}).html("Taking too long to connect to Facebook. Check your internet connection and try again");
        
        $("#signLogModal").modal('show');//launch login modal
        
        return;
        
    }, 30000);
    */
    
    hideFlashMsg();//hide flash msg
        
    $("#logInFMsg").html("");//remove text
        
    
    //call fb login
    FB.login(function (response) {
        //clearTimeout(monitoringFBLoginResponseTime);//clear monitoring timeout once response is received 
        
        getReturnedInfoFromFB(response);//call function to handle response from FB
        
    }, {scope: 'email'});
}




/**
 * Take action based on the response gotten from FB (STEP TWO)
 * @param {type} response
 * @returns {undefined}
 */
function getReturnedInfoFromFB(response) {
    if (response.status === "connected") {
        console.log("Connected. About to make FB API call");
        
        //make API call to get necessary info
        makeFBAPICall();
    } 
    
    else if ((response.status === "not_authorized") || (response.status === "unknown")) {
        console.log(response.status);
        
        //display error message and stop execution
        $("#logInFMsg").css({'color':'red', 'fontSize':'11px'}).html("Could not complete the log in process");
        
        $("#signLogModal").modal('show');//launch login modal
    }
    
    else {//if unknown response was returned by FB
        console.log(response);
        
        //display error message and stop execution
        $("#logInFMsg").css({'color':'red', 'fontSize':'11px'}).html("Could not connect to Facebook at this time");
        
        $("#signLogModal").modal('show');//launch login modal
        return;
    }
}




/**
 * Make API call to get user's details if user is connected to FB (STEP THREE)
 * @returns {undefined}
 */
function makeFBAPICall() {
    console.log("Making FB API call");
    
    displayFlashMsg("Connected to Facebook. Getting info....", spinnerClass, 'black', '');
    
    
    //await response from FB for a while and show error if nothing was received
    monitorRespTimeForAPICall = setTimeout(function(){
        FB.logout();
        
        //display error message and stop execution
        changeFlashMsgContent("Taking too long to retrieve your data from Facebook. Check your internet connection and try again", '', 'red', '', '');
        
        //$("#signLogModal").modal('show');//launch login modal
        
        return;
        
    }, 15000);
    
    
    
    FB.api('/me?fields=email, first_name, last_name', function (response) {
        //clear time out monitoring response from FB for calling FB.api
        clearTimeout(monitorRespTimeForAPICall);
        
        var email = response.email;
        var firstName = response.first_name;
        var lastName = response.last_name;
        
        //send details to server to complete log in
        //method header: handleSocialLogIn(email, firstName, lastName, socialLoginType, callback)
        handleSocialLogIn(email, firstName, lastName, "Facebook", '');//in main.js
    });
}



/**
 * 
 * @param {type} redirectURI
 * @param {type} pictureLink
 * @param {type} textToDisplay
 * @param {type} callback
 * @returns {undefined}
 */
function postToFB(redirectURI, pictureLink, textToDisplay, callback){
    FB.ui({
        method: "share",
        redirect_uri: redirectURI,
        href: appRoot,
        picture: pictureLink,
        name: "PRACTA",
        caption: appRoot,
        description: textToDisplay
    }, function(responseFromFB){
        console.log(responseFromFB);//id of the just published post on FB
        
        if(typeof callback === "function"){
            callback(responseFromFB);
        }
    });
}